# Interactive Brokers API設定ガイド

## 概要

Interactive Brokers（インタラクティブ・ブローカーズ）のAPIを使用して、**世界中どこからでも、世界中の市場で取引可能**な自動売買システムを構築するための詳細な設定手順です。

## Interactive Brokersの特徴

### グローバルアクセス

- ✅ **世界17カ国、50以上の取引所**で取引可能
- ✅ **株式、オプション、先物、FX、債券、CFD**に対応
- ✅ **日本居住者OK**: 日本法人あり
- ✅ **多言語対応**: 日本語サポート完備

### 取引可能市場

- **米国**: NYSE, NASDAQ, AMEX
- **日本**: 東京証券取引所（TSE）、大阪取引所（OSE）
- **欧州**: LSE（ロンドン）、XETRA（ドイツ）
- **アジア**: HKEX（香港）、SGX（シンガポール）
- **その他**: カナダ、オーストラリア、中国等

### API機能

- **TWS API**: 公式API（Python, Java, C++, C#対応）
- **REST API**: Web APIも提供
- **WebSocket**: リアルタイムデータ配信
- **市場データ**: リアルタイム・履歴データ取得
- **自動発注**: プログラムからの直接発注

## 必要な情報

### 1. 口座情報

- **口座番号**: Interactive Brokersの口座番号（例: U1234567）
- **ユーザー名**: ログイン用ユーザー名
- **パスワード**: ログインパスワード

### 2. API接続情報

- **ホスト**: localhost（127.0.0.1）
- **ポート**:
  - ペーパートレーディング: 7497
  - 本番取引: 7496
- **クライアントID**: 任意の番号（1-32までの整数）

## 手動設定手順

### Step 1: Interactive Brokers口座開設

1. **公式サイトにアクセス**
   - 日本: https://www.interactivebrokers.co.jp/
   - グローバル: https://www.interactivebrokers.com/

2. **口座開設申込**
   - 「口座開設」をクリック
   - 個人口座または法人口座を選択
   - 必要事項を入力：
     - 氏名、住所、電話番号、メールアドレス
     - 職業、年収、投資経験
     - 本人確認書類のアップロード

3. **審査・承認**
   - 通常1-3営業日で審査完了
   - メールで審査結果通知
   - 初回入金（最低0ドル、推奨10,000ドル以上）

4. **ペーパートレーディングアカウント申請**
   - ログイン後、「アカウント管理」から申請
   - 仮想資金100万ドルで練習可能
   - 本番と同じ市場データ・機能を使用

### Step 2: TWS（Trader Workstation）のインストール

1. **TWSのダウンロード**
   - ログイン後、「取引プラットフォーム」からダウンロード
   - または IB Gateway（軽量版）をダウンロード
   - Mac, Windows, Linux対応

2. **TWSのインストール**
   - ダウンロードしたファイルを実行
   - インストールウィザードに従って進める
   - 完了後、TWSを起動

3. **ログイン**
   - ユーザー名とパスワードでログイン
   - ペーパートレーディングと本番取引を選択可能

### Step 3: API接続の有効化

1. **API設定を開く**
   - TWSメニュー: `ファイル` > `グローバル設定` > `API` > `設定`
   - または: `Configure` > `API` > `Settings`

2. **API接続を有効化**
   - ✅ `Enable ActiveX and Socket Clients` にチェック
   - ✅ `Read-Only API` のチェックを外す（取引を許可）
   - ✅ `Trusted IPs` に `127.0.0.1` を追加
   - ポート番号を確認（デフォルト: 7497 for paper, 7496 for live）

3. **設定を保存**
   - `OK`をクリックして保存
   - TWSを再起動

### Step 4: 環境変数の設定

1. **`.env.local`ファイルを作成**

   ```bash
   touch .env.local
   ```

2. **環境変数を設定**

   ```bash
   # Interactive Brokers API設定
   IB_HOST=127.0.0.1
   IB_PORT=7497  # 7497=ペーパートレーディング, 7496=本番取引
   IB_CLIENT_ID=1
   IB_ACCOUNT_ID=your_account_id  # 例: U1234567
   IB_PAPER_TRADING=true  # ペーパートレーディングの場合

   # 取引設定
   TRADING_PASSWORD=your_trading_password
   MAX_TRADING_AMOUNT=10000  # USD
   ```

### Step 5: 接続テストの実行

```bash
# Interactive Brokersの設定
npm run setup:ib

# 接続テスト
npm run test:ib-connection
```

## 取引可能市場の設定

### 米国市場（推奨）

- **取引時間**: 9:30-16:00 EST（夏時間: 22:30-5:00 JST、冬時間: 23:30-6:00 JST）
- **主要銘柄**: AAPL, GOOGL, MSFT, TSLA, AMZN等
- **手数料**: 1株あたり0.005ドル（最低1ドル）
- **リアルタイムデータ**: 無料（一部有料）

### 日本市場

- **取引時間**: 9:00-15:00 JST
- **主要銘柄**: 7203（トヨタ）, 6758（ソニー）, 9984（ソフトバンク）等
- **手数料**: 取引額の0.08%（最低80円）
- **リアルタイムデータ**: 有料（月額料金）

### 欧州市場

- **取引時間**: 各取引所により異なる
- **主要取引所**: LSE（ロンドン）, XETRA（ドイツ）
- **手数料**: 地域により異なる

### アジア市場

- **取引時間**: 各取引所により異なる
- **主要取引所**: HKEX（香港）, SGX（シンガポール）
- **手数料**: 地域により異なる

## システム要件

### ハードウェア

- **CPU**: デュアルコア以上推奨
- **メモリ**: 4GB以上推奨
- **ストレージ**: 1GB以上の空き容量
- **ネットワーク**: 安定したインターネット接続

### ソフトウェア

- **OS**: Mac, Windows, Linux
- **Node.js**: v18以上
- **TWS/IB Gateway**: 最新版
- **TypeScript**: v4以上

## トラブルシューティング

### よくある問題

**1. 接続エラー: "Connection refused"**

- 原因: TWS/IB Gatewayが起動していない
- 解決策: TWS/IB Gatewayを起動してから再試行

**2. 認証エラー: "Not authenticated"**

- 原因: API接続が有効になっていない
- 解決策: TWS設定でAPI接続を有効化

**3. ポートエラー: "Port already in use"**

- 原因: 指定ポートが使用中
- 解決策: クライアントIDを変更するか、別のポートを使用

**4. 市場データエラー: "Market data not subscribed"**

- 原因: 市場データのサブスクリプションが必要
- 解決策: アカウント管理から市場データを申込

### サポート

**Interactive Brokers日本サポート:**

- 電話: 03-4588-9700（平日 8:00-17:00）
- メール: support@interactivebrokers.co.jp
- チャット: TWSからライブチャット利用可能

**オンラインリソース:**

- 公式API仕様: https://www.interactivebrokers.co.jp/jp/trading/ib-api.php
- ユーザーガイド: https://www.interactivebrokers.com/en/software/api/apiguide/tables/api_guide.htm
- フォーラム: https://www.interactivebrokers.com/en/trading/ibforum.php

## セキュリティと注意事項

### セキュリティ

- **二要素認証**: 必ず有効化すること
- **IPアドレス制限**: Trusted IPsの設定
- **APIキー管理**: 環境変数で管理、コードに直接記述しない
- **定期的なパスワード変更**: 3ヶ月ごとに推奨

### 取引制限

- **最小取引単位**: 1株から
- **最大注文数**: 1日あたり制限なし（API制限あり）
- **レバレッジ**: 最大4倍（デイトレード）、2倍（オーバーナイト）

### 法的・税務

- **確定申告**: 海外証券会社での取引は確定申告必須
- **外国税額控除**: 米国株配当の二重課税対策
- **為替差益**: 為替変動による損益も課税対象

## 推奨ワークフロー

### 1. ペーパートレーディング（1-3ヶ月）

- 仮想資金で戦略をテスト
- システムの動作確認
- リスク管理の検証

### 2. 少額での本番取引（1-3ヶ月）

- 1,000-5,000ドルで開始
- 実際の市場での動作確認
- 手数料・スリッページの確認

### 3. 本格運用

- 資金を段階的に増加
- 複数市場への展開
- 継続的な監視と最適化

## まとめ

Interactive Brokersを使用することで：

- ✅ **世界中どこにいても取引可能**
- ✅ **世界中の市場にアクセス可能**
- ✅ **24時間自動売買が可能**（市場時間内）
- ✅ **低コストでグローバル分散投資**

**Interactive Brokers APIの設定が完了したら、世界中の市場で自動売買システムを運用できます！**
